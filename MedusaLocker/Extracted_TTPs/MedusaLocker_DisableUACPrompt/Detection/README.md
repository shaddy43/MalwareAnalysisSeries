### MedusaLocker

<p align="center">
  <img src="../../Assets/Medusa.png" alt="MedusaLocker Image" width="300px">
</p>

This TTP is used to disable UAC prompt in the victim system and has been extracted from MedusaLocker Ransomware. It modifies registry keys to disable UAC prompt. It requires **Admin privileges** to disable the UAC on the system. Once the testcase has successfully been executed, every process can be opened as admin without the admin prompt shown on the screen.

The test case doesn't necessarily disable UAC. But only disables the prompt, which means that the malware can open any process as admin without any consent from user and can easily elevate privileges.

#### Detection Indicators
The detection indicators in the UAC disable TTP of MedusaLocker Ransomware are:
- Registry Key: **"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"**
- Registry Value Name: "ConsentPromptBehaviorAdmin"
- Registry Value Data: 0

### Log Sources
I have configured multiple log sources in my detection lab. I am using **Azure Sentinel** as my SIEM solution. The following logs are injested into SIEM:
- Microsoft Defender XDR logs
- Windows Security Audit logs
- Sysmon Logs with sysmon-moduler configuration

### Detection Engineering with Defender XDR
The following query is looking for registry events and filtering the data based on registry key **"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"**, which is used to disable UAC in medusa locker ransomware. This key could be used to enable or bypass UAC on the system. If the value of **ConsentPromptBehaviorAdmin** entity is set to 0 then every process could be started as admin without prompt.

```kql
DeviceRegistryEvents
| where RegistryKey contains "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"
| project TimeGenerated, RegistryKey, RegistryValueName, RegistryValueData, PreviousRegistryValueData, InitiatingProcessFileName
| where RegistryValueName contains "ConsentPromptBehaviorAdmin" and RegistryValueData contains "0"
```

<p align="center">
  <img src="Screenshots/defender.png" alt="detection rule1" width="600px">
</p>

### Detection Engineering with Sysmon
The logic of query is similar in Sysmon logs. The EventIDs related to registry changes are 12, 13, 14. I am looking for registry related events that have the object containing **"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"**. In sysmon logs, the configuration that i am using also provides MITRE mapping and could be seen in the results.

```kql
WindowsEvent //(sysmon)
| where EventID in (12, 13, 14)
| where EventData contains "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"
| project TimeGenerated, Computer, EventID, EventType = EventData.EventType, Image = EventData.Image, RuleName = EventData.RuleName, TargetObject = EventData.TargetObject
| where TargetObject contains "ConsentPromptBehaviorAdmin" 
```

<p align="center">
  <img src="Screenshots/sysmon.png" alt="detection rule2" width="600px">
</p>