### NanoCore 1.2.2.0

<p align="center">
  <img src="../../../Assets/Medusa.png" alt="MedusaLocker Image" width="300px">
</p>

Ransomware typically kills services running in a system to maximize its impact and increase the likelihood of a ransom payment. By terminating services related to antivirus and security software, ransomware can avoid detection and prevent its removal, allowing it to encrypt files without interference. Disabling database services and backup solutions ensures that organizations cannot easily restore their data from backups, thereby amplifying the pressure to pay the ransom. Additionally, stopping critical business services disrupts operations, causing significant downtime and financial loss. This combination of tactics—disabling security measures, hindering recovery efforts, and causing operational disruption—creates a dire situation for the victim, making them more likely to comply with the attackers’ demands to regain control of their systems and data.

In case of MedusaLocker Ransomware, it also contains a pre-defined list of services that it stops and deletes before launching the encryption operation.

#### Detection Indicators
The detection indicators are:
- List of services that it **kills** (stop & delete)

### Log Sources
I have configured multiple log sources in my detection lab. I am using **Azure Sentinel** as my SIEM solution. The following logs are injested into SIEM:
- Microsoft Defender XDR logs
- Windows Security Audit logs
- Sysmon Logs with sysmon-moduler configuration

### Detection Engineering with Defender XDR
I noticed a behavior with XDR logs, whenever a service is deleted, its registry key is removed from the system. I based my detection on this behvaior.

```kql
DeviceRegistryEvents
| where ActionType contains "RegistryKeyDeleted"
| where PreviousRegistryKey has_any ("wrapper", "DefWatch", "defragsvc", "ccEvtMgr", "ccSetMgr", "SavRoam", "sqlservr", "sqlagent", "sqladhlp", "Culserver", "RTVscan", "RTVscan", "sqlbrowser", "SQLADHLP", "QBIDPService", "Intuit.QuickBooks.FCS", "QBCFMonitorService", "sqlwriter", "msmdsrv", "tomcat6", "zhudongfangyu", "SQLADHLP", "vmware-usbarbitator64", "vmware-converter", "dbsrv12")
| project TimeGenerated, ActionType, DeviceName, InitiatingProcessFileName, PreviousRegistryKey
```

<p align="center">
  <img src="Screenshots/defender.png" alt="detection rule1" width="600px">
</p>


### Detection Engineering with Sysmon
Logic is same with sysmon logs.

```kql
WindowsEvent //(Sysmon)
| where EventID == 12
| where EventData.TargetObject has_any ("wrapper", "DefWatch", "defragsvc", "ccEvtMgr", "ccSetMgr", "SavRoam", "sqlservr", "sqlagent", "sqladhlp", "Culserver", "RTVscan", "RTVscan", "sqlbrowser", "SQLADHLP", "QBIDPService", "Intuit.QuickBooks.FCS", "QBCFMonitorService", "sqlwriter", "msmdsrv", "tomcat6", "zhudongfangyu", "SQLADHLP", "vmware-usbarbitator64", "vmware-converter", "dbsrv12")
| project TimeGenerated, EventID, Computer, EventType = EventData.EventType, Image = EventData.Image, TargetObject = EventData.TargetObject, Channel
```

<p align="center">
  <img src="Screenshots/sysmon.png" alt="detection rule2" width="600px">
</p>